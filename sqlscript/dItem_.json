{
	"name": "dItem_",
	"properties": {
		"folder": {
			"name": "LCoA"
		},
		"content": {
			"query": "use dynamics365_financeandoperations_d365techdelivery_dev_sandbox\ngo\n\nif (Object_Id('stoneridge.dItem') is not null) \n   drop view stoneridge.dItem\ngo\n\ncreate view stoneridge.dItem as\nwith\ncategoryPivot as (\n  select erpc.Product \n        ,min(case erch.Name when 'CA Ecommerce' then erc.Name end) as [CA Ecommerce]\n        ,min(case erch.Name when 'Color' then erc.Name end) as [Color]\n        ,min(case erch.Name when 'Exclusive For' then erc.Name end) as [Exclusive For]\n        ,min(case erch.Name when 'Financial Reporting Category' then erc.Name end) as [Financial Reporting Category]\n        ,min(case erch.Name when 'Global Design' then erc.Name end) as [Global Design]\n        ,min(case erch.Name when 'Group Class' then erc.Name end) as [Group Class]\n        ,min(case erch.Name when 'Group Color' then erc.Name end) as [Group Color]\n        ,min(case erch.Name when 'Group Department' then erc.Name end) as [Group Department]\n        ,min(case erch.Name when 'Group Division' then erc.Name end) as [Group Division]\n        ,min(case erch.Name when 'Group Product Type' then erc.Name end) as [Group Product Type]\n        ,min(case erch.Name when 'Made-of' then erc.Name end) as [Made-of]\n        ,min(case erch.Name when 'New releases' then erc.Name end) as [New releases]\n        ,min(case erch.Name when 'Procurement' then erc.Name end) as [Procurement]\n        ,min(case erch.Name when 'Retail Brand' then erc.Name end) as [Retail Brand]\n        ,min(case erch.Name when 'Retail Capacity' then erc.Name end) as [Retail Capacity]\n        ,min(case erch.Name when 'Retail Class' then erc.Name end) as [Retail Class]\n        ,min(case erch.Name when 'Retail Cookware Promo' then erc.Name end) as [Retail Cookware Promo]\n        ,min(case erch.Name when 'Retail Department' then erc.Name end) as [Retail Department]\n        ,min(case erch.Name when 'Retail Division' then erc.Name end) as [Retail Division]\n        ,min(case erch.Name when 'Retail Local Color' then erc.Name end) as [Retail Local Color]\n        ,min(case erch.Name when 'Retail Material' then erc.Name end) as [Retail Material]\n        ,min(case erch.Name when 'Retail Quality' then erc.Name end) as [Retail Quality]\n        ,min(case erch.Name when 'Retail Range' then erc.Name end) as [Retail Range]\n        ,min(case erch.Name when 'Retail Shape' then erc.Name end) as [Retail Shape]\n        ,min(case erch.Name when 'Retail Size' then erc.Name end) as [Retail Size]\n        ,min(case erch.Name when 'Retail Tools Promo' then erc.Name end) as [Retail Tools Promo]\n        ,min(case erch.Name when 'US DTC Distribution' then erc.Name end) as [US DTC Distribution]\n        ,min(case erch.Name when 'Used-for' then erc.Name end) as [Used-for]\n  from EcoResProductCategory erpc \n       left outer join EcoResCategoryHierarchy erch on erch.RecId = erpc.CategoryHierarchy\n       left outer join EcoResCategory erc on erc.RecId = erpc.Category\n group by erpc.Product \n),\nenglishProductNames as (\n  select erpt.Product\n        ,erpt.Name as [Product Name]\n        ,erpt.Description as [Product Description]\n    from EcoResProductTranslation erpt\n where erpt.LanguageId = 'En-US'\n),\nbatchAttributePivot as (\n  select pba.ItemId\n        ,min(case pba.PdsBatchAttribId when 'MID' then pba.PdsBatchAttribValue end) as [Prism Id]\n        ,min(case pba.PdsBatchAttribId when 'COO' then pba.PdsBatchAttribValue end) as [Country of Origin]\n        ,min(case pba.PdsBatchAttribId when 'Full CI Weight (Kg)' then pba.PdsBatchAttribValue end) as [Full CI Weight (Kg)]\n--??        ,min(case pba.PdsBatchAttribId when 'Gross Weight (Kg)' then pba.PdsBatchAttribValue end) as [Gross Weight (Kg)]\n--??        ,min(case pba.PdsBatchAttribId when 'Net weight (Kg)' then pba.PdsBatchAttribValue end) as [Net weight (Kg)]\n    from PdsBatchAttributes pba\n           inner join InventBatch ib on ib.ItemId = pba.ItemId and ib.InventBatchId = pba.InventBatchId\n   where ib.AMERPrimaryBatch = 1\n     and ib.DataAreaId = 'DUS'\n     and pba.DataAreaId = 'DUS' \n   group by pba.ItemId\n),\nitemCost as (\n  select ItemId\n        ,avg(Price/PriceUnit) as [Average Unit Cost]\n    from InventItemPrice iips\n   where ActivationDate <= cast(getDate() as date)\n     and CostingType = 3 -- InventItemCostingType::Last\n     and DataAreaId = 'DUS'\n   group by ItemId\n)\n--primaryBatchBarcode as (\n--  select iibc.ItemId\n--        ,iibc.ItemBarCode as [Primary Barcode]\n--    from InventItemBarcode iibc\n--           left outer join InventBatch ib on ib.ItemId = iibc.ItemId \n--                                         and ib.AMERPrimaryBatch = 1\n--  where ib.DataAreaId = 'DUS'\n--    and iibc.DataAreaId = 'DUS'\n--    and iibc.InventDimId = 'AllBlank' \n--    and iibc.Qty = 1\n--)\nselect it.ItemId as [Item Id]\n      ,epn.[Product Name]\n      ,epn.[Product Description]\n      ,it.DefaultDimension as [Default Dimension RecId]\n--      ,pb.[Primary Barcode]\n      ,[CA Ecommerce]\n      ,[Color]\n      ,[Exclusive For]\n      ,[Financial Reporting Category]\n      ,[Global Design]\n      ,[Group Class]\n      ,[Group Color]\n      ,[Group Department]\n      ,[Group Division]\n      ,[Group Product Type]\n      ,[Made-of]\n      ,[New releases]\n      ,[Procurement]\n      ,[Retail Brand]\n      ,[Retail Capacity]\n      ,[Retail Class]\n      ,[Retail Cookware Promo]\n      ,[Retail Department]\n      ,[Retail Division]\n      ,[Retail Local Color]\n      ,[Retail Material]\n      ,[Retail Quality]\n      ,[Retail Range]\n      ,[Retail Shape]\n      ,[Retail Size]\n      ,[Retail Tools Promo]\n      ,[US DTC Distribution]\n      ,[Used-for]\n      ,erpls.StateId as [Product Lifecycle State Id]\n      ,erpls.Description as [Product Lifecycle State]\n      ,[Prism Id]\n      ,[Country of Origin]\n      ,CAST([Full CI Weight (Kg)] as DECIMAL(10,2)) as [Full CI Weight (Kg)]\n      ,CAST([Full CI Weight (Kg)] as DECIMAL(10,2)) / 1000 as [Full CI Weight (Ton)]\n      ,[Average Unit Cost]\n--    ,[Gross Weight (Kg)]\n--    ,[Net weight (Kg)]\n  from InventTable it\n         left outer join englishProductNames epn on epn.Product = it.Product\n         left outer join categoryPivot cp on cp.Product = it.Product\n--         left outer join primaryBatchBarcode pb on pb.ItemId = it.ItemId \n         left outer join batchAttributePivot bap on bap.ItemId = it.ItemId\n         left outer join EcoResProductLifecycleState erpls on erpls.StateId = it.ProductLifecycleStateId\n         left outer join itemCost ic on ic.ItemId = it.ItemId\n where it.DataAreaId = 'DUS'\n/* Test\nselect top 100 * from stoneridge.dItem\nselect 'InventTable', count(*) from InventTable where DataAreaId = 'DUS' -- 6542\nselect 'stoneridge.dItem', count(*) from stoneridge.dItem -- 6542 (should be the same as above)\nselect 'Dim_ItemHierarchy', count(*) from Dim_ItemHierarchy -- 535769\n*/\ngo\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}